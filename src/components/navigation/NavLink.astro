---
/**
 * NavLink Component
 *
 * Reusable navigation link with proper 44px touch targets (WCAG AA).
 * Styled as uppercase label text with muted colour.
 * Automatically highlights when on the current page using aria-current.
 */

/**
 * Props for the NavLink component.
 */
interface Props {
  /**
   * Link destination URL.
   */
  href: string;

  /**
   * Additional CSS classes.
   */
  class?: string;
}

const {href, class: className} = Astro.props;
const pathname = Astro.url.pathname;

// Check if this link is the current page
// Handle both exact matches and nested routes (e.g., /blog matches /blog/post-slug)
const isActive = pathname === href || pathname.startsWith(`${href}/`);
// Exact match used for preventing refetch on current page
const isExactMatch = pathname === href;
---

<a
  href={href}
  class:list={["nav-link", {active: isActive}, className]}
  aria-current={isActive ? "page" : undefined}
  data-nav-exact={isExactMatch ? "true" : undefined}
>
  <slot />
</a>

<script>
  let handlerAttached = false;

  /**
   * Sync nav link active states with current URL.
   * Required because header uses transition:persist, so DOM isn't replaced on navigation.
   */
  const syncNavLinkStates = (): void => {
    const pathname = window.location.pathname;

    document
      .querySelectorAll<HTMLAnchorElement>("a.nav-link")
      .forEach((link) => {
        const href = link.getAttribute("href");
        if (!href) {
          return;
        }

        // Check for active state (exact match or nested route)
        const isActive = pathname === href || pathname.startsWith(`${href}/`);
        // Check for exact match (used for preventing refetch)
        const isExactMatch = pathname === href;

        // Update classes and attributes
        link.classList.toggle("active", isActive);
        if (isActive) {
          link.setAttribute("aria-current", "page");
        } else {
          link.removeAttribute("aria-current");
        }

        if (isExactMatch) {
          link.setAttribute("data-nav-exact", "true");
        } else {
          link.removeAttribute("data-nav-exact");
        }
      });
  };

  /**
   * Attach delegated click handler for nav links.
   * Uses capture phase to intercept before Astro's ClientRouter.
   */
  const attachClickHandler = (): void => {
    if (handlerAttached) {
      return;
    }
    handlerAttached = true;

    document.addEventListener(
      "click",
      (e) => {
        const link = (e.target as Element).closest("a.nav-link");
        if (link?.getAttribute("data-nav-exact") === "true") {
          e.preventDefault();
        }
      },
      {capture: true}
    );
  };

  // Initial setup
  syncNavLinkStates();
  attachClickHandler();

  // Re-sync after Astro view transitions (handler persists via delegation)
  document.addEventListener("astro:after-swap", syncNavLinkStates);
</script>

<style>
  .nav-link {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    text-transform: uppercase;
    letter-spacing: var(--tracking-labels);
    color: var(--muted);
    transition: color var(--transition-fast);
    /* 44px touch target (WCAG AA) */
    min-height: var(--size-touch-target);
    display: inline-flex;
    align-items: center;
  }

  .nav-link:hover {
    color: var(--fg);
  }

  .nav-link.active,
  .nav-link[aria-current="page"] {
    color: var(--fg);
  }

  .nav-link:focus-visible {
    outline: var(--outline-width) solid var(--fg);
    outline-offset: var(--outline-offset);
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .nav-link {
      transition: none;
    }
  }
</style>
