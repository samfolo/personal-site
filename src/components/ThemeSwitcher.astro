---
/**
 * ThemeSwitcher Component
 *
 * Four-button theme selector with diagonal colour preview.
 * Persists selection to localStorage and updates body class.
 */

import ThemeSwitcherButton, { type ThemeId } from './ThemeSwitcherButton.astro';

interface Props {
  size?: 'sm' | 'md';
}

const { size = 'md' } = Astro.props;

const themes: Array<{ id: ThemeId; label: string }> = [
  { id: 'steel', label: 'Steel grey + warm cream' },
  { id: 'purple', label: 'Dark purple + gold' },
  { id: 'charcoal', label: 'Warm charcoal + off-white' },
  { id: 'teal', label: 'Dark teal + coral' },
];
---

<div class="theme-switcher" data-size={size}>
  {/* Desktop: four-button switcher */}
  <div class="theme-switcher-desktop gap-2">
    {themes.map((theme) => (
      <ThemeSwitcherButton
        size={size}
        theme={theme.id}
        label={theme.label}
        class="theme-button"
      />
    ))}
  </div>

  {/* Mobile: single cycle button (shows current theme) */}
  <ThemeSwitcherButton
    size="md"
    isActive={true}
    label="Cycle colour theme"
    class="theme-toggle-mobile"
  />
</div>

<style>
  .theme-switcher {
    display: flex;
    gap: var(--space-2);
  }

  /* Desktop switcher: hidden on mobile, visible on desktop */
  .theme-switcher-desktop {
    display: none;
    visibility: hidden;
  }

  /* Mobile toggle: visible on mobile, hidden on desktop */
  .theme-switcher :global(.theme-toggle-mobile) {
    display: flex;
    visibility: visible;
  }

  /* Breakpoint aligned with LogoMark (32rem / 512px) */
  @container page (min-width: 32rem) {
    .theme-switcher-desktop {
      display: flex;
      visibility: visible;
    }

    .theme-switcher :global(.theme-toggle-mobile) {
      display: none;
      visibility: hidden;
    }
  }
</style>

<script>
  import { setFavicon } from '../scripts/favicon';
  import { setThemeColor } from '../scripts/theme-color';

  const THEME_KEY = 'theme';
  const THEME_LABELS: Record<string, string> = {
    steel: 'Steel grey + warm cream',
    purple: 'Dark purple + gold',
    charcoal: 'Warm charcoal + off-white',
    teal: 'Dark teal + coral',
  };
  const THEME_ORDER = Object.keys(THEME_LABELS);
  const THEME_CLASSES = THEME_ORDER.map((id) => `theme-${id}`);

  function setTheme(themeId: string): void {
    document.documentElement.classList.remove(...THEME_CLASSES);
    document.documentElement.classList.add(`theme-${themeId}`);
    localStorage.setItem(THEME_KEY, themeId);
    setFavicon(themeId);
    setThemeColor(themeId);
    updateActiveStates(themeId);
  }

  function cycleTheme(): void {
    const current = getCurrentTheme();
    const currentIndex = THEME_ORDER.indexOf(current);
    const nextIndex = (currentIndex + 1) % THEME_ORDER.length;
    setTheme(THEME_ORDER[nextIndex]);
  }

  function updateActiveStates(activeTheme: string): void {
    document.querySelectorAll('.theme-button').forEach((button) => {
      const isActive = button.getAttribute('data-theme') === activeTheme;
      button.setAttribute('data-active', String(isActive));
    });

    // Update mobile toggle aria-label
    const label = THEME_LABELS[activeTheme] ?? activeTheme;
    document.querySelectorAll('.theme-toggle-mobile').forEach((button) => {
      button.setAttribute('aria-label', `Cycle colour theme, currently ${label}`);
    });
  }

  function getCurrentTheme(): string {
    for (const cls of document.documentElement.classList) {
      if (cls.startsWith('theme-')) {
        return cls.replace('theme-', '');
      }
    }
    return 'steel';
  }

  function init(): void {
    const currentTheme = getCurrentTheme();
    updateActiveStates(currentTheme);

    // Desktop: individual theme buttons
    document.querySelectorAll('.theme-button').forEach((button) => {
      button.addEventListener('click', () => {
        const themeId = button.getAttribute('data-theme');
        if (themeId) {
          setTheme(themeId);
        }
      });
    });

    // Mobile: cycle toggle button
    document.querySelectorAll('.theme-toggle-mobile').forEach((button) => {
      button.addEventListener('click', cycleTheme);
    });
  }

  // Initialise on DOM ready and after Astro page transitions
  init();
  document.addEventListener('astro:after-swap', init);
</script>
