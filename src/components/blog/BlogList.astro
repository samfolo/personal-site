---
/**
 * BlogList Component
 *
 * Displays a list of blog posts grouped by month.
 * Posts are shown in reverse chronological order.
 */

import {formatDate} from "../../utils/format-date";

import {Body, Overline} from "../typography";

import BlogListItem from "./BlogListItem.astro";

/**
 * Simplified post data for list rendering.
 */
interface Post {
  /**
   * Post title.
   */
  title: string;

  /**
   * ISO date string.
   */
  date: string;

  /**
   * URL slug for the post.
   */
  slug: string;
}

/**
 * Props for the BlogList component.
 */
interface Props {
  /**
   * Posts to display in the list.
   */
  posts: Post[];
}

const {posts} = Astro.props;

/**
 * Groups posts by month-year and returns in reverse chronological order
 */
const groupPostsByMonth = (posts: Post[]): Map<string, Post[]> => {
  // Sort posts by date (newest first)
  const sortedPosts = [...posts].sort(
    (a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()
  );

  // Group by YYYY-MM key
  const groups = new Map<string, Post[]>();

  for (const post of sortedPosts) {
    const date = new Date(post.date);
    const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}`;

    if (!groups.has(key)) {
      groups.set(key, []);
    }
    groups.get(key)!.push(post);
  }

  return groups;
};

const groupedPosts = groupPostsByMonth(posts);
---

<div class="blog-list">
  {
    posts.length === 0 ? (
      <Body tag="p">No blog posts to display.</Body>
    ) : (
      Array.from(groupedPosts.entries()).map(([_key, monthPosts]) => (
        <section class="blog-month-group">
          <Overline tag="h2" class="month-label">
            {formatDate(new Date(monthPosts[0].date), "month-year")}
          </Overline>
          <ul class="post-list">
            {monthPosts.map((post) => (
              <BlogListItem
                title={post.title}
                date={post.date}
                slug={post.slug}
              />
            ))}
          </ul>
        </section>
      ))
    )
  }
</div>

<style>
  .blog-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-7);
  }

  .blog-month-group {
    display: flex;
    flex-direction: column;
  }

  .month-label {
    margin-bottom: var(--space-4);
  }

  .post-list {
    display: flex;
    flex-direction: column;
  }
</style>
