---
/**
 * ThemeSwitcher Component
 *
 * Four-button theme selector with diagonal colour preview.
 * Persists selection to localStorage and updates body class.
 *
 * Component Split:
 * ThemeSwitcher orchestrates theme selection, handles desktop/mobile responsive
 * behaviour, and manages state via script tag. ThemeSwitcherButton renders
 * individual buttons with visual styling for both desktop (four buttons) and
 * mobile (single cycle button).
 *
 * :global() Usage:
 * The .theme-toggle-mobile class uses :global() because the button is rendered
 * by ThemeSwitcherButton (child component) and Astro scopes styles to the
 * component where they're defined. We need to style the child's output from
 * the parent for responsive logic coordination.
 *
 * Breakpoint Note:
 * The 32rem breakpoint is hardcoded because CSS custom properties cannot be
 * used in @container queries (CSS limitation). This value is aligned with
 * --container-lg for consistency.
 */

import {THEME_LABELS, THEME_ORDER} from "../../config/themes";
import type {Theme} from "../../config/themes";

import ThemeSwitcherButton from "./ThemeSwitcherButton.astro";
import type {ThemeSwitcherSize} from "./types";

interface Props {
  size?: ThemeSwitcherSize;
}

interface ThemeOption {
  id: Theme;
  label: string;
}

const {size = "md"} = Astro.props;

const THEMES: ThemeOption[] = THEME_ORDER.map((id) => ({
  id,
  label: THEME_LABELS[id],
}));
---

<div class="theme-switcher" data-size={size}>
  {/* Desktop: four-button switcher */}
  <div class="theme-switcher-desktop gap-2">
    {
      THEMES.map((theme) => (
        <ThemeSwitcherButton
          size={size}
          theme={theme.id}
          label={theme.label}
          class="theme-button"
        />
      ))
    }
  </div>

  {/* Mobile: single cycle button (shows current theme) */}
  <ThemeSwitcherButton
    size="md"
    isActive={true}
    label="Cycle colour theme"
    class="theme-toggle-mobile"
  />
</div>

<style>
  .theme-switcher {
    display: flex;
    gap: var(--space-2);
  }

  /* Desktop switcher: hidden on mobile, visible on desktop */
  .theme-switcher-desktop {
    display: none;
    visibility: hidden;
  }

  /* Mobile toggle: visible on mobile, hidden on desktop */
  .theme-switcher :global(.theme-toggle-mobile) {
    display: flex;
    visibility: visible;
  }

  /* Breakpoint aligned with LogoMark (32rem / 512px) */
  @container page (min-width: 32rem) {
    .theme-switcher-desktop {
      display: flex;
      visibility: visible;
    }

    .theme-switcher :global(.theme-toggle-mobile) {
      display: none;
      visibility: hidden;
    }
  }
</style>

<script>
  import {STORAGE_KEYS} from "../../config/storage";
  import {THEME_CLASSES, THEME_LABELS, THEME_ORDER} from "../../config/themes";
  import type {Theme} from "../../config/themes";
  import {setFavicon} from "../../scripts/favicon";
  import {setThemeColor} from "../../scripts/theme-color";

  const setTheme = (themeId: Theme): void => {
    document.documentElement.classList.remove(...THEME_CLASSES);
    document.documentElement.classList.add(`theme-${themeId}`);
    localStorage.setItem(STORAGE_KEYS.THEME, themeId);
    setFavicon(themeId);
    setThemeColor(themeId);
    updateActiveStates(themeId);
  };

  const cycleTheme = (): void => {
    const current = getCurrentTheme();
    const currentIndex = THEME_ORDER.indexOf(current);
    const nextIndex = (currentIndex + 1) % THEME_ORDER.length;
    setTheme(THEME_ORDER[nextIndex]);
  };

  const updateActiveStates = (activeTheme: Theme): void => {
    document.querySelectorAll(".theme-button").forEach((button) => {
      const isActive = button.getAttribute("data-theme") === activeTheme;
      button.setAttribute("data-active", String(isActive));
    });

    // Update mobile toggle aria-label
    const label = THEME_LABELS[activeTheme];
    document.querySelectorAll(".theme-toggle-mobile").forEach((button) => {
      button.setAttribute(
        "aria-label",
        `Cycle colour theme, currently ${label}`
      );
    });
  };

  const getCurrentTheme = (): Theme => {
    for (const cls of document.documentElement.classList) {
      if (cls.startsWith("theme-")) {
        return cls.replace("theme-", "") as Theme;
      }
    }
    return "steel";
  };

  const init = (): void => {
    const currentTheme = getCurrentTheme();
    updateActiveStates(currentTheme);

    // Desktop: individual theme buttons
    document.querySelectorAll(".theme-button").forEach((button) => {
      button.addEventListener("click", () => {
        const themeId = button.getAttribute("data-theme") as Theme | null;
        if (themeId) {
          setTheme(themeId);
        }
      });
    });

    // Mobile: cycle toggle button
    document.querySelectorAll(".theme-toggle-mobile").forEach((button) => {
      button.addEventListener("click", cycleTheme);
    });
  };

  // Initialise on DOM ready and after Astro page transitions
  init();
  document.addEventListener("astro:after-swap", init);
</script>
