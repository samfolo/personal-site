---
/**
 * JSON-LD Component
 *
 * Provides structured data for search engines:
 * - Person schema for the site owner (primary entity)
 * - Article schema for blog posts
 * - WebSite schema (legacy, retained for compatibility)
 */

import {SITE} from "../../config";
import type {
  JSONLDArticle,
  JSONLDArticleData,
  JSONLDPerson,
  JSONLDPersonEntity,
  JSONLDType,
  JSONLDWebSite,
} from "../../types";

/**
 * Props for the JSONLD component.
 */
interface Props {
  /**
   * Schema type to render.
   */
  type: JSONLDType;

  /**
   * Article data for Article schema type.
   */
  article?: JSONLDArticleData;
}

const {type, article} = Astro.props;

// Canonical URL for article: strip query params
const articleUrl = new URL(Astro.url.pathname, Astro.site ?? SITE.url).href;

const author: JSONLDPerson = {
  "@type": "Person",
  name: SITE.author.name,
  url: SITE.url,
  jobTitle: SITE.author.jobTitle,
  sameAs: [SITE.author.github, SITE.author.linkedin],
};

/**
 * Build the appropriate schema based on type.
 */
const buildSchema = (): JSONLDPersonEntity | JSONLDArticle | JSONLDWebSite => {
  if (type === "Person") {
    return {
      "@context": "https://schema.org",
      "@type": "Person",
      name: SITE.author.name,
      url: SITE.url,
      jobTitle: SITE.author.jobTitle,
      description: SITE.description,
      worksFor: {
        "@type": "Organization",
        name: SITE.author.worksFor.name,
        url: SITE.author.worksFor.url,
      },
      address: {
        "@type": "PostalAddress",
        addressLocality: SITE.author.address.locality,
        addressCountry: SITE.author.address.country,
      },
      sameAs: [SITE.author.github, SITE.author.linkedin],
    };
  }

  if (type === "Article" && article) {
    return {
      "@context": "https://schema.org",
      "@type": "Article",
      headline: article.headline,
      description: article.description,
      url: articleUrl,
      datePublished: article.publishDate.toISOString(),
      dateModified: (article.updatedDate ?? article.publishDate).toISOString(),
      author,
      keywords: article.tags?.join(", "),
    };
  }

  // WebSite fallback
  return {
    "@context": "https://schema.org",
    "@type": "WebSite",
    name: SITE.name,
    url: SITE.url,
    description: SITE.description,
    author,
  };
};

const schema = buildSchema();
---

<script
  is:inline
  type="application/ld+json"
  set:html={JSON.stringify(schema)}
/>
