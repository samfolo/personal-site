/**
 * Shiki Syntax Highlighting Styles
 *
 * Provides styling for code blocks rendered by Shiki with:
 * - CSS variable-based theming
 * - Floating language label and copy button
 * - Transformer support (diff, highlight, focus)
 */

/* ==========================================================================
   CSS Variables Mapping

   Astro 5 uses --astro-code-* prefix. We map our --shiki-* tokens to these.
   ========================================================================== */

:root {
  --astro-code-foreground: var(--shiki-foreground, var(--fg));
  --astro-code-background: var(--shiki-background, var(--rule));
  --astro-code-token-constant: var(--shiki-token-constant);
  --astro-code-token-string: var(--shiki-token-string);
  --astro-code-token-comment: var(--shiki-token-comment);
  --astro-code-token-keyword: var(--shiki-token-keyword);
  --astro-code-token-parameter: var(--shiki-token-parameter);
  --astro-code-token-function: var(--shiki-token-function);
  --astro-code-token-string-expression: var(--shiki-token-string-expression);
  --astro-code-token-punctuation: var(--shiki-token-punctuation);
  --astro-code-token-link: var(--shiki-token-link);
}

/* ==========================================================================
   Base Code Block Wrapper

   .code-block wraps the <pre> element and provides positioning context
   for the floating label and copy button.
   ========================================================================== */

.code-block {
  position: relative;
  margin-top: var(--space-5);
  margin-bottom: var(--space-5);
}

/* ==========================================================================
   Pre Element Base Styles
   ========================================================================== */

.prose :where(pre.astro-code):not(:where([class~="not-prose"], [class~="not-prose"] *)),
pre.astro-code {
  margin: 0;
  padding: 0;
  font-family: var(--font-mono);
  font-size: var(--text-sm);
  line-height: var(--leading-24);
  background-color: var(--astro-code-background);
  color: var(--astro-code-foreground);
  border-radius: var(--space-2);
}

/* Code within pre - reset inherited styles */
pre.astro-code code {
  display: block;
  /* Extra top padding to clear the floating language label and copy button */
  padding: calc(var(--space-6) + var(--space-2)) var(--space-5) var(--space-5);
  background: transparent;
  font-family: inherit;
  font-size: inherit;
  line-height: inherit;
  /* Collapse newline text nodes between .line spans */
  white-space: normal;
}

/* Individual lines - block display for proper wrapping */
pre.astro-code .line {
  display: block;
  min-height: var(--leading-24);
  /* Restore pre-wrap for wrapping long lines within each line span */
  white-space: pre-wrap;
}

/* ==========================================================================
   Floating Language Label

   Subtle tag in top-left corner showing the code language.
   ========================================================================== */

.code-lang {
  position: absolute;
  top: var(--space-2);
  left: var(--space-2);
  padding: var(--space-1) var(--space-2);
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  font-weight: var(--font-medium);
  color: var(--muted);
  line-height: var(--leading-16);
  z-index: var(--z-raised);
  pointer-events: none;
}

/* ==========================================================================
   Floating Copy Button

   Copy button in top-right corner.
   ========================================================================== */

.code-copy {
  position: absolute;
  top: var(--space-2);
  right: var(--space-2);
  padding: var(--space-1) var(--space-2);
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  font-weight: var(--font-medium);
  color: var(--muted);
  background-color: transparent;
  border: var(--border-hairline) solid var(--muted);
  border-radius: var(--space-1);
  cursor: pointer;
  opacity: 0;
  transition:
    opacity var(--transition-fast),
    color var(--transition-fast),
    border-color var(--transition-fast),
    background-color var(--transition-fast);
  z-index: var(--z-raised);
}

.code-block:hover .code-copy,
.code-block:focus-within .code-copy {
  opacity: 1;
}

.code-copy:hover {
  color: var(--fg);
  border-color: var(--fg);
  background-color: var(--code-header-bg);
}

.code-copy:focus-visible {
  opacity: 1;
  color: var(--fg);
  border-color: var(--fg);
  background-color: var(--code-header-bg);
  outline: var(--outline-width) solid var(--fg);
  outline-offset: var(--outline-offset-tight);
}

/* ==========================================================================
   Transformer Styles: Diff

   Lines marked with [!code ++] or [!code --]

   Layout: All code in diff blocks has a gutter column for +/- symbols.
   Non-diff lines leave the gutter empty to maintain alignment.
   ========================================================================== */

pre.astro-code.has-diff code {
  position: relative;
  /* Extra left padding creates the gutter for +/- symbols */
  padding-left: var(--space-6);
}

pre.astro-code.has-diff .line {
  position: relative;
}

pre.astro-code.has-diff .line.diff {
  /* Extend background into gutter and leave space-2 gap on edges */
  margin-left: calc(-1 * (var(--space-6) - var(--space-2)));
  margin-right: calc(-1 * (var(--space-5) - var(--space-2)));
  padding-left: calc(var(--space-6) - var(--space-2));
  padding-right: calc(var(--space-5) - var(--space-2));
}

pre.astro-code .line.diff.add {
  background-color: var(--code-diff-add-bg);
}

pre.astro-code .line.diff.add::before {
  content: '+';
  position: absolute;
  left: var(--space-2);
  color: var(--code-diff-add-symbol);
  font-weight: var(--font-bold);
}

pre.astro-code .line.diff.remove {
  background-color: var(--code-diff-remove-bg);
}

pre.astro-code .line.diff.remove::before {
  content: '-';
  position: absolute;
  left: var(--space-2);
  color: var(--code-diff-remove-symbol);
  font-weight: var(--font-bold);
}

/* ==========================================================================
   Transformer Styles: Highlight

   Lines marked with [!code highlight]
   Consistent with diff styling - leaves space-2 gap on edges.
   ========================================================================== */

pre.astro-code .line.highlighted {
  margin-left: calc(-1 * (var(--space-5) - var(--space-2)));
  margin-right: calc(-1 * (var(--space-5) - var(--space-2)));
  padding-left: calc(var(--space-5) - var(--space-2) - var(--border-thin));
  padding-right: calc(var(--space-5) - var(--space-2));
  background-color: var(--code-highlight-bg);
  border-left: var(--border-thin) solid var(--highlight);
}

/* Highlighted lines in diff blocks - use diff gutter padding */
pre.astro-code.has-diff .line.highlighted {
  margin-left: calc(-1 * (var(--space-6) - var(--space-2)));
  padding-left: calc(var(--space-6) - var(--space-2) - var(--border-thin));
}

/* ==========================================================================
   Transformer Styles: Focus

   Lines marked with [!code focus]
   Unfocused lines are dimmed
   ========================================================================== */

pre.astro-code.has-focused .line:not(.focused) {
  opacity: var(--code-focus-opacity);
  filter: blur(1px);
  transition:
    opacity var(--transition-fast),
    filter var(--transition-fast);
}

pre.astro-code.has-focused:hover .line:not(.focused) {
  opacity: var(--code-focus-hover-opacity);
  filter: blur(0);
}

/* ==========================================================================
   Transformer Styles: Word Highlight

   Words marked with [!code word:term]
   ========================================================================== */

pre.astro-code .highlighted-word {
  background-color: var(--code-highlight-bg);
  padding: var(--space-05) var(--space-1);
  border-radius: var(--space-1);
  border-bottom: var(--border-hairline) solid var(--highlight);
}

/* ==========================================================================
   Reduced Motion
   ========================================================================== */

@media (prefers-reduced-motion: reduce) {
  pre.astro-code.has-focused .line:not(.focused) {
    transition: none;
  }

  .code-copy {
    transition: none;
  }
}

/* ==========================================================================
   Print Styles
   ========================================================================== */

@media print {
  .code-copy,
  .code-lang {
    display: none;
  }
}
