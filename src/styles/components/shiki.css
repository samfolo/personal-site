/**
 * Code Block Styles
 *
 * Single source of truth for all code block styling:
 * - Syntax token definitions (global → theme → language)
 * - Shiki/Astro variable mapping
 * - Component layout and appearance
 * - Transformer support (diff, highlight, focus)
 *
 * Token cascade: :root defaults → .theme-* → .theme-* [data-language="*"]
 */

/* ==========================================================================
   1. TOKEN DEFINITIONS - Global Defaults

   Base syntax colours used when no theme is active.
   These are the fallback values for all tokens.
   ========================================================================== */

:root {
  /* Core syntax tokens */
  --shiki-foreground: var(--fg);
  --shiki-background: oklch(0.19 0.01 255.6);
  --shiki-token-keyword: oklch(0.72 0.17 285);
  --shiki-token-function: oklch(0.77 0.14 255);
  --shiki-token-constant: oklch(0.75 0.14 220);
  --shiki-token-string: oklch(0.72 0.13 150);
  --shiki-token-string-expression: oklch(0.70 0.13 130);
  --shiki-token-comment: oklch(0.52 0.02 255);
  --shiki-token-punctuation: oklch(0.66 0.03 255);
  --shiki-token-parameter: oklch(0.80 0.11 238);
  --shiki-token-link: var(--highlight);

  /* Granular tokens - numbers & units */
  --shiki-token-number: oklch(0.78 0.12 180);
  --shiki-token-unit: oklch(0.78 0.12 180);

  /* Granular tokens - operators & variables */
  --shiki-token-operator: var(--shiki-foreground);
  --shiki-token-variable: oklch(0.82 0.10 238);

  /* Granular tokens - types */
  --shiki-token-type: oklch(0.75 0.12 195);

  /* Granular tokens - HTML/XML */
  --shiki-token-tag: var(--shiki-token-keyword);
  --shiki-token-attribute: oklch(0.82 0.10 238);

  /* Granular tokens - CSS specific */
  --shiki-token-property: oklch(0.82 0.10 238);
  --shiki-token-property-value: var(--shiki-token-constant);
  --shiki-token-selector: oklch(0.78 0.14 50);

  /* Granular tokens - special strings */
  --shiki-token-regexp: oklch(0.70 0.15 25);
  --shiki-token-escape: oklch(0.78 0.14 50);

  /* Code block UI */
  --code-header-bg: oklch(from var(--rule) calc(l - 0.04) c h);
  --code-header-border: oklch(from var(--rule) calc(l + 0.05) c h);
  --code-overlay-border: oklch(from var(--rule) calc(l + 0.1) c h);

  /* Diff colours */
  --code-diff-add-bg: oklch(0.21 0.05 150);
  --code-diff-remove-bg: oklch(0.21 0.05 25);
  --code-diff-add-symbol: oklch(0.65 0.15 150);
  --code-diff-remove-symbol: oklch(0.65 0.15 25);
  --code-highlight-bg: oklch(0.22 0.01 255.6);

  /* Focus mode */
  --code-focus-opacity: 0.3;
  --code-focus-hover-opacity: 0.7;
}

/* ==========================================================================
   2. TOKEN DEFINITIONS - Per-Theme

   Each theme overrides the tokens to match its colour palette.
   Only override tokens that differ from the global defaults.
   ========================================================================== */

/* --------------------------------------------------------------------------
   Steel Theme (blue-grey) - Primary hue: 255
   -------------------------------------------------------------------------- */
.theme-steel {
  --shiki-background: oklch(0.19 0.01 255.6);
  --shiki-token-keyword: oklch(0.72 0.17 285);
  --shiki-token-function: oklch(0.77 0.14 255);
  --shiki-token-constant: oklch(0.75 0.14 220);
  --shiki-token-string: oklch(0.72 0.13 150);
  --shiki-token-string-expression: oklch(0.70 0.13 130);
  --shiki-token-comment: oklch(0.52 0.02 255);
  --shiki-token-punctuation: oklch(0.66 0.03 255);
  --shiki-token-parameter: oklch(0.80 0.11 238);

  --code-diff-add-bg: oklch(0.21 0.05 150);
  --code-diff-remove-bg: oklch(0.21 0.05 25);
  --code-highlight-bg: oklch(0.22 0.01 255.6);
}

/* --------------------------------------------------------------------------
   Purple Theme - Primary hue: 300, Secondary: 97.89 (gold)
   -------------------------------------------------------------------------- */
.theme-purple {
  --shiki-foreground: var(--fg);
  --shiki-background: oklch(0.2 0.02 303);
  --shiki-token-keyword: oklch(0.7 0.15 330);
  --shiki-token-function: oklch(0.7 0.15 300);
  --shiki-token-constant: var(--shiki-token-string);
  --shiki-token-string: oklch(0.8 0.05 97.89);
  --shiki-token-string-expression: var(--shiki-token-function);
  --shiki-token-comment: oklch(0.6 0.02 300);
  --shiki-token-punctuation: oklch(0.8 0.01 0);
  --shiki-token-parameter: oklch(0.8 0.05 280);
  --shiki-token-variable: var(--fg);
  --shiki-token-type: var(--shiki-token-function);
  --shiki-token-tag: oklch(0.72 0.17 285);
  --shiki-token-escape: oklch(0.8 0.13 95);
  --shiki-token-number: oklch(0.8 0.1 40);
  --shiki-token-unit: oklch(0.8 0.1 40);

  --code-diff-add-bg: oklch(0.21 0.05 154);
  --code-diff-remove-bg: oklch(0.21 0.05 21);
  --code-highlight-bg: oklch(0.22 0.02 303);
}

/* --------------------------------------------------------------------------
   Charcoal Theme (neutral) - Warm hue: 60, minimal chroma
   -------------------------------------------------------------------------- */
.theme-charcoal {
  --shiki-background: oklch(0.19 0 0);
  --shiki-token-keyword: oklch(0.82 0.02 60);
  --shiki-token-function: oklch(0.77 0.02 60);
  --shiki-token-constant: oklch(0.75 0.02 60);
  --shiki-token-string: oklch(0.70 0.02 60);
  --shiki-token-string-expression: oklch(0.68 0.02 60);
  --shiki-token-comment: oklch(0.48 0.01 60);
  --shiki-token-punctuation: oklch(0.58 0.01 60);
  --shiki-token-parameter: oklch(0.80 0.02 60);

  --code-diff-add-bg: oklch(0.22 0.05 145);
  --code-diff-remove-bg: oklch(0.22 0.05 20);
  --code-diff-add-symbol: oklch(0.65 0.10 150);
  --code-diff-remove-symbol: oklch(0.65 0.10 25);
  --code-highlight-bg: oklch(0.22 0 0);
}

/* --------------------------------------------------------------------------
   Teal Theme - Primary hue: 195, Secondary: 34 (coral)
   -------------------------------------------------------------------------- */
.theme-teal {
  --shiki-background: oklch(0.19 0.02 195.58);
  --shiki-token-keyword: oklch(0.72 0.17 225);
  --shiki-token-function: oklch(0.77 0.14 195);
  --shiki-token-constant: oklch(0.75 0.14 195);
  --shiki-token-string: oklch(0.72 0.13 34);
  --shiki-token-string-expression: oklch(0.70 0.13 34);
  --shiki-token-comment: oklch(0.50 0.03 195);
  --shiki-token-punctuation: oklch(0.62 0.03 195);
  --shiki-token-parameter: oklch(0.78 0.11 115);

  --code-diff-add-bg: oklch(0.22 0.06 150);
  --code-diff-remove-bg: oklch(0.22 0.06 26);
  --code-highlight-bg: oklch(0.23 0.02 195.73);
}

/* ==========================================================================
   3. VARIABLE MAPPING

   Maps --shiki-* tokens to Astro's --astro-code-* convention.
   Set on pre.astro-code so per-language overrides cascade correctly.
   ========================================================================== */

pre.astro-code {
  /* Core tokens */
  --astro-code-foreground: var(--shiki-foreground, var(--fg));
  --astro-code-background: var(--shiki-background, var(--rule));
  --astro-code-token-constant: var(--shiki-token-constant);
  --astro-code-token-string: var(--shiki-token-string);
  --astro-code-token-comment: var(--shiki-token-comment);
  --astro-code-token-keyword: var(--shiki-token-keyword);
  --astro-code-token-parameter: var(--shiki-token-parameter);
  --astro-code-token-function: var(--shiki-token-function);
  --astro-code-token-string-expression: var(--shiki-token-string-expression);
  --astro-code-token-punctuation: var(--shiki-token-punctuation);
  --astro-code-token-link: var(--shiki-token-link);

  /* Granular tokens (for custom TextMate theme) */
  --astro-code-token-number: var(--shiki-token-number);
  --astro-code-token-unit: var(--shiki-token-unit);
  --astro-code-token-operator: var(--shiki-token-operator);
  --astro-code-token-variable: var(--shiki-token-variable);
  --astro-code-token-type: var(--shiki-token-type);
  --astro-code-token-tag: var(--shiki-token-tag);
  --astro-code-token-attribute: var(--shiki-token-attribute);
  --astro-code-token-property: var(--shiki-token-property);
  --astro-code-token-property-value: var(--shiki-token-property-value);
  --astro-code-token-selector: var(--shiki-token-selector);
  --astro-code-token-regexp: var(--shiki-token-regexp);
  --astro-code-token-escape: var(--shiki-token-escape);
}

/* ==========================================================================
   4. PER-LANGUAGE-PER-THEME OVERRIDES

   Fine-tune tokens for specific languages within each theme.
   Only add overrides where needed - tokens inherit from theme defaults.

   Selector pattern: .theme-* pre.astro-code[data-language="*"]
   ========================================================================== */

/* --------------------------------------------------------------------------
   Steel Theme - Language Overrides
   -------------------------------------------------------------------------- */

/* No overrides yet */

/* --------------------------------------------------------------------------
   Purple Theme - Language Overrides
   -------------------------------------------------------------------------- */

.theme-purple pre.astro-code[data-language="css"] {
  --shiki-token-keyword: var(--shiki-token-string);
  --shiki-token-variable: var(--shiki-foreground);
  --shiki-token-property: var(--shiki-foreground);
  --shiki-token-attribute: var(--shiki-token-string);
  --shiki-token-operator: var(--shiki-token-string);
  --shiki-token-selector: var(--fg);
  --shiki-token-property-value: var(--shiki-token-constant);
  --shiki-token-function: var(--shiki-token-parameter);
}

.theme-purple pre.astro-code[data-language="yaml"],
.theme-purple pre.astro-code[data-language="python"],
.theme-purple pre.astro-code[data-language="rust"],
.theme-purple pre.astro-code[data-language="go"] {
  --shiki-token-constant: var(--shiki-token-tag);
}

.theme-purple pre.astro-code[data-language="json"] {
  --shiki-token-constant: var(--shiki-token-keyword);
  --shiki-token-property: var(--shiki-token-string);
}

.theme-purple pre.astro-code[data-language="html"],
.theme-purple pre.astro-code[data-language="xml"] {
  --shiki-token-selector: var(--fg);
  --shiki-token-attribute: oklch(0.8 0.05 97.89);
  --shiki-token-property: var(--fg);
  --shiki-token-property-value: oklch(0.8 0.05 97.89);
}

.theme-purple pre.astro-code[data-language="markdown"] {
  --shiki-token-keyword: var(--shiki-foreground);
  --shiki-token-link: var(--shiki-token-string);
}

/* --------------------------------------------------------------------------
   Charcoal Theme - Language Overrides
   -------------------------------------------------------------------------- */

/* No overrides yet */

/* --------------------------------------------------------------------------
   Teal Theme - Language Overrides
   -------------------------------------------------------------------------- */

/* No overrides yet */

/* ==========================================================================
   5. COMPONENT STYLES - Layout & Appearance
   ========================================================================== */

/* Code block wrapper - positioning context for label and copy button */
.code-block {
  position: relative;
  margin-top: var(--space-5);
  margin-bottom: var(--space-5);
}

/* Pre element base styles */
.prose :where(pre.astro-code):not(:where([class~="not-prose"], [class~="not-prose"] *)),
pre.astro-code {
  margin: 0;
  padding: 0;
  font-family: var(--font-mono);
  font-size: var(--text-sm);
  line-height: var(--leading-24);
  background-color: var(--astro-code-background) !important;
  color: var(--astro-code-foreground);
  border-radius: var(--space-2);
}

/* Code within pre - reset inherited styles */
pre.astro-code code {
  display: block;
  padding: calc(var(--space-6) + var(--space-2)) var(--space-5) var(--space-5);
  background: transparent;
  font-family: inherit;
  font-size: inherit;
  line-height: inherit;
  white-space: normal;
}

/* Individual lines - block display for proper wrapping */
pre.astro-code .line {
  display: block;
  min-height: var(--leading-24);
  white-space: pre-wrap;
}

/* --------------------------------------------------------------------------
   Floating Language Label
   -------------------------------------------------------------------------- */

.code-lang {
  position: absolute;
  top: var(--space-2);
  left: var(--space-2);
  padding: var(--space-1) var(--space-2);
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  font-weight: var(--font-medium);
  color: var(--muted);
  line-height: var(--leading-16);
  z-index: var(--z-raised);
  pointer-events: none;
}

/* --------------------------------------------------------------------------
   Floating Copy Button
   -------------------------------------------------------------------------- */

.code-copy {
  position: absolute;
  top: var(--space-2);
  right: var(--space-2);
  padding: var(--space-1) var(--space-2);
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  font-weight: var(--font-medium);
  color: var(--muted);
  background-color: transparent;
  border: var(--border-hairline) solid var(--muted);
  border-radius: var(--space-1);
  cursor: pointer;
  opacity: 0;
  transition:
    opacity var(--transition-fast),
    color var(--transition-fast),
    border-color var(--transition-fast),
    background-color var(--transition-fast);
  z-index: var(--z-raised);
}

.code-block:hover .code-copy,
.code-block:focus-within .code-copy {
  opacity: 1;
}

.code-copy:hover {
  color: var(--fg);
  border-color: var(--fg);
  background-color: var(--code-header-bg);
}

.code-copy:focus-visible {
  opacity: 1;
  color: var(--fg);
  border-color: var(--fg);
  background-color: var(--code-header-bg);
  outline: var(--outline-width) solid var(--fg);
  outline-offset: var(--outline-offset-tight);
}

/* ==========================================================================
   6. TRANSFORMER STYLES
   ========================================================================== */

/* --------------------------------------------------------------------------
   Diff - Lines marked with [!code ++] or [!code --]
   -------------------------------------------------------------------------- */

pre.astro-code.has-diff code {
  position: relative;
  padding-left: var(--space-6);
}

pre.astro-code.has-diff .line {
  position: relative;
}

pre.astro-code.has-diff .line.diff {
  margin-left: calc(-1 * (var(--space-6) - var(--space-2)));
  margin-right: calc(-1 * (var(--space-5) - var(--space-2)));
  padding-left: calc(var(--space-6) - var(--space-2));
  padding-right: calc(var(--space-5) - var(--space-2));
}

pre.astro-code .line.diff.add {
  background-color: var(--code-diff-add-bg);
}

pre.astro-code .line.diff.add::before {
  content: '+';
  position: absolute;
  left: var(--space-2);
  color: var(--code-diff-add-symbol);
  font-weight: var(--font-bold);
}

pre.astro-code .line.diff.remove {
  background-color: var(--code-diff-remove-bg);
}

pre.astro-code .line.diff.remove::before {
  content: '-';
  position: absolute;
  left: var(--space-2);
  color: var(--code-diff-remove-symbol);
  font-weight: var(--font-bold);
}

/* --------------------------------------------------------------------------
   Highlight - Lines marked with [!code highlight]
   -------------------------------------------------------------------------- */

pre.astro-code .line.highlighted {
  margin-left: calc(-1 * (var(--space-5) - var(--space-2)));
  margin-right: calc(-1 * (var(--space-5) - var(--space-2)));
  padding-left: calc(var(--space-5) - var(--space-2) - var(--border-thin));
  padding-right: calc(var(--space-5) - var(--space-2));
  background-color: var(--code-highlight-bg);
  border-left: var(--border-thin) solid var(--highlight);
}

pre.astro-code.has-diff .line.highlighted {
  margin-left: calc(-1 * (var(--space-6) - var(--space-2)));
  padding-left: calc(var(--space-6) - var(--space-2) - var(--border-thin));
}

/* --------------------------------------------------------------------------
   Focus - Lines marked with [!code focus]
   -------------------------------------------------------------------------- */

pre.astro-code.has-focused .line:not(.focused) {
  opacity: var(--code-focus-opacity);
  filter: blur(1px);
  transition:
    opacity var(--transition-fast),
    filter var(--transition-fast);
}

pre.astro-code.has-focused:hover .line:not(.focused) {
  opacity: var(--code-focus-hover-opacity);
  filter: blur(0);
}

/* --------------------------------------------------------------------------
   Word Highlight - Words marked with [!code word:term]
   -------------------------------------------------------------------------- */

pre.astro-code .highlighted-word {
  background-color: var(--code-highlight-bg);
  padding: var(--space-05) var(--space-1);
  border-radius: var(--space-1);
  border-bottom: var(--border-hairline) solid var(--highlight);
}

/* ==========================================================================
   7. ACCESSIBILITY
   ========================================================================== */

@media (prefers-reduced-motion: reduce) {
  pre.astro-code.has-focused .line:not(.focused) {
    transition: none;
  }

  .code-copy {
    transition: none;
  }
}

@media print {
  .code-copy,
  .code-lang {
    display: none;
  }
}
